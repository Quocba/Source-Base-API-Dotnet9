# Source Base Dotnet API

Tài liệu này mô tả chi tiết kiến trúc, các thành phần và hướng dẫn sử dụng source code của dự án Source Base Dotnet API.

## 1. Tổng Quan Kiến Trúc (Architecture Overview)

Dự án được xây dựng dựa trên kiến trúc **Clean Architecture** kết hợp với **CQRS** (Command Query Responsibility Segregation) sử dụng MediatR.

Kiến trúc tuân thủ **Dependency Rule**: các dependency chỉ hướng vào bên trong. Core Layer (Domain, Application) không phụ thuộc vào Infrastructure hay External Services.

### Sơ Đồ Phụ Thuộc (Dependency Graph)

```mermaid
graph TD
    %% Presentation Layer
    API["BaseAPI (Presentation)"]
    
    %% Core Layers
    App[Application Layer]
    Dom[Domain Layer]
    
    %% Infrastructure & Services
    Infra[Infrastructure]
    Email[EmailService]
    Redis[RedisService]
    Rabbit[RabbitMQContract]
    
    %% Dependencies
    API --> App
    API --> Dom
    API --> Infra
    API --> Email
    API --> Redis
    API --> Rabbit
    
    Infra --> App
    Infra --> Dom
    
    App --> Dom
    
    Email --> App
    Redis --> App
    Rabbit --> App
    Rabbit --> Dom
    
    %% Styling
    classDef core fill:#f9f,stroke:#333,stroke-width:2px;
    classDef infra fill:#9cf,stroke:#333,stroke-width:2px;
    class App,Dom core
    class Infra,Email,Redis,Rabbit infra
```

### Các Layer Chính:

*   **BaseAPI (Presentation Layer)**:
    *   **Vai trò**: Entry point của ứng dụng.
    *   **Thành phần**: Controllers, Middleware, Configuration (DI, Serilog, JWT, Swagger).
    *   **Dependency**: Phụ thuộc vào tất cả các project khác để thực hiện Dependency Injection (wiring up).

*   **Application (Core Layer)**:
    *   **Vai trò**: Chứa business logic, use cases.
    *   **Thành phần**: CQRS Handlers (MediatR), DTOs, Validation, **Interfaces** (Abstractions) cho Infrastructure/Services.
    *   **Dependency**: Chỉ phụ thuộc vào `Domain`. **Không** phụ thuộc vào Infrastructure/Database/External libs.

*   **Domain (Core Layer)**:
    *   **Vai trò**: Trái tim của hệ thống.
    *   **Thành phần**: Entities, Value Objects, Enums, Constants, Domain Exceptions.
    *   **Dependency**: **Không** phụ thuộc vào bất kỳ layer nào khác.

*   **Infrastructure**:
    *   **Vai trò**: Triển khai các logic kỹ thuật, kết nối Database, File System.
    *   **Thành phần**: DBContext (EF Core), Repository Implementation, UnitOfWork, External APIs Impl (Google Drive).
    *   **Dependency**: Phụ thuộc vào `Application` (để implement interfaces) và `Domain`.

*   **External Services (Plugins)**:
    *   **EmailService**: Implement `IEmailSender` được định nghĩa trong Application.
    *   **RedisService**: Implement `IRedisService` được định nghĩa trong Application.
    *   **RabbitMQContract**: Định nghĩa Consumers xử lý message.

---

## 2. Project & Package Dependencies

| Project | Packages Chính | Mục Đích |
| :--- | :--- | :--- |
| **Domain** | `Microsoft.EntityFrameworkCore` | Attributes cho Entities. |
| | `Newtonsoft.Json` | Xử lý JSON chung. |
| **Application** | `MediatR` | Pattern CQRS. |
| | `Dapper` | Truy vấn đọc dữ liệu (Query side). |
| | `Elastic.Clients.Elasticsearch` | (Lưu ý: Nên wrap bằng Interface nếu muốn strict Clean Arch). |
| **Infrastructure** | `Microsoft.EntityFrameworkCore.SqlServer` | SQL Server Provider. |
| | `Google.Apis.Drive.v3` | Giao tiếp Google Drive API. |
| **BaseAPI** | `AspNetCoreRateLimit` | Rate Limiting. |
| | `Serilog` | Logging. |
| | `Swashbuckle` | Swagger Docs. |

---

## 3. RabbitMQ & Messaging

Dự án sử dụng **MassTransit** để làm việc với **RabbitMQ**.

### Cấu Hình
Cấu hình trong `appsettings.json` mapping vào `RabbitMQConfig`.

### Workflow
1.  **Application** gửi message thông qua `IPublishEndpoint` (của MassTransit) hoặc qua Bus abstraction.
2.  **RabbitMQContract** chứa các `Consumer` đăng ký nhận message từ Queue.
3.  **Dependency Injection**: Consumer được đăng ký tại `BaseAPI`.

---

## 4. Hướng Dẫn Setup & Chạy

1.  **Prerequisites**: SDK .NET 9, SQL Server, RabbitMQ, Redis.
2.  **Config**: Update connection strings trong `appsettings.json`.
3.  **Migration**:
    ```bash
    dotnet ef database update --project Infrastructure --startup-project BaseAPI
    ```
4.  **Run**: Set `BaseAPI` as Startup Project.

---
*Generated by Antigravity*